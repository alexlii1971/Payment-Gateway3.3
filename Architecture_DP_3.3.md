### **é¡¹ç›®æ¶æ„è®¾è®¡æ–¹æ¡ˆï¼ˆç¬¬ä¸€éƒ¨åˆ†ï¼‰**  
ğŸ“‚ é¡¹ç›®æ¶æ„è®¾è®¡æ–¹æ¡ˆ (Architecture_DP_3.3.md)
â”‚  
â”œâ”€â”€ **ä¸€ã€é¡¹ç›®æ¦‚è¿°**
â”‚   â”œâ”€â”€ 1.1 é¡¹ç›®åç§° & ç›®æ ‡
â”‚   â”œâ”€â”€ 1.2 é€‚ç”¨åœºæ™¯
â”‚  
â”œâ”€â”€ **äºŒã€æ¶æ„è®¾è®¡åŸåˆ™**
â”‚   â”œâ”€â”€ 2.1 éµå¾ª WordPress & WooCommerce è§„èŒƒ
â”‚   â”œâ”€â”€ 2.2 æ¨¡å—åŒ–è®¾è®¡ & äº‹ä»¶é©±åŠ¨
â”‚   â”œâ”€â”€ 2.3 ç½‘ç»œçº§ä¸å­ç«™çº§æ•°æ®éš”ç¦»
â”‚   â”œâ”€â”€ 2.4 å®‰å…¨æ€§è¦æ±‚
â”‚  
â”œâ”€â”€ **ä¸‰ã€æ¨¡å—åˆ’åˆ†ä¸èŒè´£**
â”‚   â”œâ”€â”€ 3.1 PaymentUIModuleï¼ˆæ”¯ä»˜ UI ç®¡ç†ï¼‰
â”‚   â”œâ”€â”€ 3.2 NotificationModuleï¼ˆçŸ­ä¿¡ & é‚®ä»¶é€šçŸ¥ï¼‰
â”‚   â”œâ”€â”€ 3.3 OrderProcessorï¼ˆè®¢å•æ”¯ä»˜ & é€€æ¬¾å¤„ç†ï¼‰
â”‚   â”œâ”€â”€ 3.4 WebhookManagerï¼ˆWebhook å¤„ç† & å¤±è´¥é‡è¯•ï¼‰
â”‚   â”œâ”€â”€ 3.5 AdminModuleï¼ˆç®¡ç†å‘˜ç•Œé¢ï¼‰
â”‚   â”œâ”€â”€ 3.6 APIClientï¼ˆæ”¯ä»˜ç½‘å…³ API å°è£…ï¼‰
â”‚  
â”œâ”€â”€ **å››ã€æŠ€æœ¯å®ç°è·¯å¾„**
â”‚   â”œâ”€â”€ 4.1 æ”¯ä»˜å›è°ƒåœ°å€åŠ¨æ€ç”Ÿæˆ
â”‚   â”œâ”€â”€ 4.2 è®¢å•å­˜å‚¨ `site_id`
â”‚   â”œâ”€â”€ 4.3 Webhook è‡ªåŠ¨æ³¨å†Œä¸ç»´æŠ¤
â”‚   â”œâ”€â”€ 4.4 ç½‘ç»œçº§ä¸å­ç«™çº§ç®¡ç†ç•Œé¢
â”‚  
â”œâ”€â”€ **äº”ã€ä¼˜åŒ–åˆ†æä¸è°ƒæ•´**
â”‚   â”œâ”€â”€ 5.1 æ¨¡å—é€šä¿¡è§£è€¦ï¼ˆäº‹ä»¶é©±åŠ¨æ”¹é€ ï¼‰
â”‚   â”œâ”€â”€ 5.2 æ”¯ä»˜é…ç½®ç»§æ‰¿æœºåˆ¶ä¼˜åŒ–
â”‚  
â”œâ”€â”€ **å…­ã€å…³é”®ä»£ç ç»“æ„**
â”‚   â”œâ”€â”€ 6.1 PluginManagerï¼ˆæ¨¡å—æ³¨å†Œä¸åŠ è½½ï¼‰
â”‚   â”œâ”€â”€ 6.2 APIClientï¼ˆæ”¯ä»˜çŠ¶æ€åŒæ­¥ï¼‰
â”‚   â”œâ”€â”€ 6.3 WebhookSecurityï¼ˆå®‰å…¨éªŒè¯ï¼‰
â”‚  
â”œâ”€â”€ **ä¸ƒã€éƒ¨ç½²ä¸å…¼å®¹æ€§**
â”‚   â”œâ”€â”€ 7.1 å¤šç«™ç‚¹å…¼å®¹æ€§ä¼˜åŒ–
â”‚   â”œâ”€â”€ 7.2 æ•°æ®åº“è¡¨è®¾è®¡
â”‚  
â”œâ”€â”€ **å…«ã€æœªæ¥æ‰©å±•æ–¹å‘**
â”‚   â”œâ”€â”€ 8.1 äº‹ä»¶é©±åŠ¨æ¶æ„å¢å¼º
â”‚   â”œâ”€â”€ 8.2 æ”¯ä»˜ç½‘å…³æŠ½è±¡å±‚
â”‚   â”œâ”€â”€ 8.3 è‡ªåŠ¨åŒ–æµ‹è¯•è¦†ç›–
â”‚  
â”œâ”€â”€ **ä¹ã€æ•°æ®åº“ä¸æ•°æ®éš”ç¦»è®¾è®¡**
â”‚   â”œâ”€â”€ 9.1 æ•°æ®å­˜å‚¨ç­–ç•¥
â”‚   â”œâ”€â”€ 9.2 æ—¥å¿—éš”ç¦»è®¾è®¡
â”‚   â”œâ”€â”€ 9.3 åˆ†è¡¨æŸ¥è¯¢ä¼˜åŒ–
â”‚  
â”œâ”€â”€ **åã€å®‰å…¨æ€§å¢å¼ºè®¾è®¡**
â”‚   â”œâ”€â”€ 10.1 æ”¯ä»˜è¯·æ±‚é˜²ç¯¡æ”¹
â”‚   â”œâ”€â”€ 10.2 Webhook å®‰å…¨é˜²æŠ¤
â”‚   â”œâ”€â”€ 10.3 æ•æ„Ÿæ•°æ®åŠ å¯†
â”‚  
â”œâ”€â”€ **åä¸€ã€ç½‘ç»œçº§ä¸å­ç«™çº§ç®¡ç†ç•Œé¢å®ç°**
â”‚   â”œâ”€â”€ 11.1 ç½‘ç»œçº§ç®¡ç†ç•Œé¢
â”‚   â”œâ”€â”€ 11.2 å­ç«™çº§ç®¡ç†ç•Œé¢
â”‚   â”œâ”€â”€ 11.3 æƒé™æ§åˆ¶
â”‚  
â”œâ”€â”€ **åäºŒã€å¼‚å¸¸å¤„ç†ä¸å®¹ç¾æœºåˆ¶**
â”‚   â”œâ”€â”€ 12.1 æ”¯ä»˜æµç¨‹å¼‚å¸¸å¤„ç†
â”‚   â”œâ”€â”€ 12.2 Webhook å¤±è´¥å®¹ç¾
â”‚   â”œâ”€â”€ 12.3 æ—¥å¿—ä¸ç›‘æ§
â”‚  
â”œâ”€â”€ **åä¸‰ã€æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ**
â”‚   â”œâ”€â”€ 13.1 é™æ€èµ„æºç¼“å­˜
â”‚   â”œâ”€â”€ 13.2 æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
â”‚   â”œâ”€â”€ 13.3 å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—
â”‚  
â”œâ”€â”€ **åå››ã€æµ‹è¯•ä¸éƒ¨ç½²æµç¨‹**
â”‚   â”œâ”€â”€ 14.1 å•å…ƒæµ‹è¯•è¦†ç›–
â”‚   â”œâ”€â”€ 14.2 ç°åº¦å‘å¸ƒç­–ç•¥
â”‚   â”œâ”€â”€ 14.3 å›æ»šæ–¹æ¡ˆ
â”‚  
â””â”€â”€ **åäº”ã€æœ€ç»ˆæ¶æ„æ€»ç»“**
    â”œâ”€â”€ 15.1 æ¶æ„ä¼˜åŠ¿
    â”œâ”€â”€ 15.2 å¾…ä¼˜åŒ–ç‚¹

---

#### **ä¸€ã€é¡¹ç›®æ¦‚è¿°**  
**é¡¹ç›®åç§°**ï¼šWordPress Multisite å¾®ä¿¡ & æ”¯ä»˜å®æ”¯ä»˜æ’ä»¶  
**æ ¸å¿ƒç›®æ ‡**ï¼š  
1. åœ¨ WordPress Multisite + WooCommerce ç¯å¢ƒä¸‹ï¼Œæä¾›é«˜æ•ˆã€å®‰å…¨çš„å¾®ä¿¡æ”¯ä»˜ & æ”¯ä»˜å®æ”¯ä»˜åŠŸèƒ½ã€‚  
2. æ”¯æŒç½‘ç»œçº§ç»Ÿä¸€ç®¡ç†æˆ–å­ç«™ç‹¬ç«‹ç®¡ç†ï¼Œä¸¥æ ¼éµå®ˆ WordPress å’Œ WooCommerce ç¼–ç è§„èŒƒã€‚  
3. æ¨¡å—åŒ–è®¾è®¡ï¼Œå„åŠŸèƒ½è§£è€¦ï¼Œæ”¯æŒå•ç‹¬å¯ç”¨/ç¦ç”¨ã€‚  

**é€‚ç”¨åœºæ™¯**ï¼š  
- WordPress Multisite ç½‘ç»œï¼Œä¸»ç«™ç»Ÿä¸€ç®¡ç†æ”¯ä»˜é…ç½®ï¼Œå­ç«™ç»§æ‰¿è§„åˆ™ã€‚  
- å•ç«™ç‚¹ç‹¬ç«‹æ¿€æ´»æ—¶ï¼Œå­ç«™ç®¡ç†å‘˜å¯ç‹¬ç«‹é…ç½®æ”¯ä»˜å‚æ•°ã€‚  

---

#### **äºŒã€æ¶æ„è®¾è®¡åŸåˆ™**  
1. **éµå¾ª WordPress & WooCommerce è§„èŒƒ**ï¼š  
   - ä½¿ç”¨ `WP_Query`ã€`WC_Order` ç­‰æ ‡å‡† APIã€‚  
   - é€šè¿‡ WordPress Hookï¼ˆAction/Filterï¼‰æ‰©å±•åŠŸèƒ½ï¼Œé¿å…ç›´æ¥ä¿®æ”¹æ ¸å¿ƒä»£ç ã€‚  
2. **æ¨¡å—åŒ–è®¾è®¡**ï¼š  
   - æŒ‰åŠŸèƒ½åˆ’åˆ†ç‹¬ç«‹æ¨¡å—ï¼ˆæ”¯ä»˜UIã€Webhookã€é€šçŸ¥æœåŠ¡ç­‰ï¼‰ï¼Œæ¨¡å—é—´é€šè¿‡äº‹ä»¶é©±åŠ¨é€šä¿¡ã€‚  
   - æ¨¡å—æ³¨å†Œæœºåˆ¶ï¼šé€šè¿‡ `PluginManager` ç±»åŠ¨æ€åŠ è½½æ¨¡å—ã€‚  
3. **ç½‘ç»œçº§ä¸å­ç«™çº§éš”ç¦»**ï¼š  
   - æ•°æ®åº“è¡¨æŒ‰ `site_id` éš”ç¦»ï¼ˆå¦‚æ—¥å¿—ã€é…ç½®ï¼‰ã€‚  
   - ç½‘ç»œçº§é…ç½®å­˜å‚¨äº `wp_sitemeta`ï¼Œå­ç«™é…ç½®å­˜å‚¨äº `wp_options`ã€‚  
4. **å®‰å…¨æ€§**ï¼š  
   - Webhook è¯·æ±‚éœ€é€šè¿‡ HMAC-SHA256 ç­¾åéªŒè¯ã€‚  
   - æ”¯ä»˜å›è°ƒ URL åŠ¨æ€ç”Ÿæˆï¼Œé˜²æ­¢ä¼ªé€ è¯·æ±‚ã€‚  

---

#### **ä¸‰ã€æ¨¡å—åˆ’åˆ†ä¸èŒè´£**  
| **æ¨¡å—åç§°**          | **èŒè´£**                                                                 | **ä¾èµ–å…³ç³»**              |  
|-----------------------|--------------------------------------------------------------------------|---------------------------|  
| **PaymentUIModule**   | ç®¡ç†å‰ç«¯æ”¯ä»˜ä½“éªŒï¼ˆå€’è®¡æ—¶ã€äºŒç»´ç åˆ·æ–°ã€è‡ªåŠ¨è·³è½¬ï¼‰                         | æ—                         |  
| **NotificationModule** | å¤„ç†çŸ­ä¿¡ & é‚®ä»¶é€šçŸ¥ï¼Œæ”¯æŒç½‘ç»œçº§é…ç½®ç»§æ‰¿                                  | ä¾èµ– `WC_Email` ç±»        |  
| **OrderProcessor**    | å¤„ç†è®¢å•æ”¯ä»˜ & é€€æ¬¾çŠ¶æ€åŒæ­¥ï¼Œå­˜å‚¨ `site_id`ï¼Œé˜²é‡å¤é€€æ¬¾                  | ä¾èµ– `WC_Order`           |  
| **WebhookManager**    | Webhook è‡ªåŠ¨æ³¨å†Œã€å¤±è´¥é‡è¯•ã€å®‰å…¨éªŒè¯ã€æ—¥å¿—è®°å½•                           | ä¾èµ– `WC_Webhook`         |  
| **AdminModule**       | æä¾›ç½‘ç»œçº§ & å­ç«™çº§ç®¡ç†ç•Œé¢ï¼ˆæ”¯ä»˜é…ç½®ã€æ—¥å¿—æŸ¥çœ‹ã€ç»Ÿè®¡ï¼‰                  | ä¾èµ– WordPress Admin API  |  
| **APIClient**         | **å°è£…å¾®ä¿¡ & æ”¯ä»˜å® API è°ƒç”¨ï¼Œå¿…é¡»ä½¿ç”¨å®˜æ–¹ SDK è¿›è¡Œé›†æˆ**                 | æ—                         |  

**SDK é›†æˆè¦æ±‚ï¼š**  
- **å¾®ä¿¡æ”¯ä»˜ï¼š** ä½¿ç”¨ `wechatpay-php`ï¼ˆhttps://github.com/wechatpay-apiv3/wechatpay-phpï¼‰  
- **æ”¯ä»˜å®æ”¯ä»˜ï¼š** ä½¿ç”¨ `alipay-sdk-php`ï¼ˆhttps://github.com/alipay/alipay-sdk-php-allï¼‰  

---

#### **å››ã€æŠ€æœ¯å®ç°è·¯å¾„**  

##### **1. æ”¯ä»˜å›è°ƒåœ°å€åŠ¨æ€ç”Ÿæˆ**  
**é—®é¢˜**ï¼šå¤šç«™ç‚¹ç¯å¢ƒä¸‹ï¼Œå­ç«™éœ€ç‹¬ç«‹å›è°ƒåœ°å€ä»¥åŒ¹é…è®¢å•ã€‚  
**å®ç°æ–¹æ¡ˆ**ï¼š  
- **ä¸»ç«™å›è°ƒåœ°å€**ï¼š`https://tao.ooo/wc-api/wechat_callback`  
- **å­ç«™å›è°ƒåœ°å€**ï¼š`https://sub.tao.ooo/wc-api/wechat_callback`  
- **åŠ¨æ€ç”Ÿæˆé€»è¾‘**ï¼š  
  ```php  
  function generate_callback_url($type) {  
      $blog_id = get_current_blog_id();  
      $base_url = get_site_url($blog_id);  
      return $base_url . "/wc-api/{$type}_callback";  
  }  
  ```  

##### **2. è®¢å•å­˜å‚¨ `site_id`**  
**æ•°æ®åº“è®¾è®¡**ï¼š  
- æ‰©å±• `wp_posts` è¡¨ï¼Œé€šè¿‡ `_site_id` Meta å­—æ®µæ ‡è®°è®¢å•æ‰€å±å­ç«™ã€‚  
- **Hook å®ç°**ï¼š  
  ```php  
  add_action('woocommerce_checkout_create_order', function ($order) {  
      $order->update_meta_data('_site_id', get_current_blog_id());  
  });  
  ```  

##### **3. Webhook è‡ªåŠ¨æ³¨å†Œä¸ç»´æŠ¤**  
**å®ç°æ­¥éª¤**ï¼š  
1. **æ’ä»¶æ¿€æ´»æ—¶**ï¼šéå†æ‰€æœ‰å­ç«™ï¼Œä¸ºæ¯ä¸ªç«™ç‚¹åˆ›å»ºç‹¬ç«‹ Webhookã€‚  
2. **å­ç«™åˆ›å»ºæ—¶**ï¼šé€šè¿‡ `wpmu_new_blog` Hook è‡ªåŠ¨æ³¨å†Œ Webhookã€‚  
3. **Webhook å‚æ•°**ï¼š  
   ```php  
   $webhook = new WC_Webhook();  
   $webhook->set_name('å¾®ä¿¡æ”¯ä»˜å›è°ƒ');  
   $webhook->set_topic('payment.wechat');  
   $webhook->set_delivery_url(generate_callback_url('wechat'));  
   $webhook->set_secret(wp_generate_password(32));  
   ```  

##### **4. ç½‘ç»œçº§ä¸å­ç«™çº§ç®¡ç†åœ°å€**  
- **ç½‘ç»œçº§ç®¡ç†ç•Œé¢**ï¼š  
  URL: `https://tao.ooo/wp-admin/network/admin.php?page=wc-multisite-payment`  
  åŠŸèƒ½ï¼šé…ç½®å…¨å±€æ”¯ä»˜ç½‘å…³ã€å¼ºåˆ¶å¯ç”¨çŸ­ä¿¡é€šçŸ¥ã€æŸ¥çœ‹å…¨ç«™æ”¯ä»˜æ—¥å¿—ã€‚  
- **å­ç«™çº§ç®¡ç†ç•Œé¢**ï¼š  
  URL: `https://sub.tao.ooo/wp-admin/admin.php?page=wc-payment-settings`  
  åŠŸèƒ½ï¼šå­ç«™ç‹¬ç«‹é…ç½®æ”¯ä»˜ APIã€æŸ¥çœ‹æœ¬åœ°æ—¥å¿—ã€æ‰‹åŠ¨åŒæ­¥è®¢å•çŠ¶æ€ã€‚  

---

#### **äº”ã€ä¼˜åŒ–åˆ†æä¸è°ƒæ•´**  

##### **ä¼˜åŒ–ç‚¹ 1ï¼šæ¨¡å—é€šä¿¡è§£è€¦**  
**é—®é¢˜**ï¼šåŸæ–¹æ¡ˆä¸­ `WebhookManager` ç›´æ¥è°ƒç”¨ `OrderProcessor` çš„æ–¹æ³•ï¼Œå¯¼è‡´è€¦åˆã€‚  
**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š  
- ä½¿ç”¨ WordPress çš„ `do_action` å®ç°äº‹ä»¶é©±åŠ¨ï¼š  
  ```php  
  // Webhook æ¥æ”¶åˆ°æ”¯ä»˜æˆåŠŸäº‹ä»¶æ—¶è§¦å‘  
  do_action('wc_payment_success', $order_id, $transaction_id);  
  // OrderProcessor ç›‘å¬è¯¥äº‹ä»¶  
  add_action('wc_payment_success', [$this, 'update_order_status']);  
  ```  

---

#### **å…­ã€éƒ¨ç½²ä¸å…¼å®¹æ€§**  
- **å¤šç«™ç‚¹æ”¯æŒ**ï¼šç¡®ä¿ `APIClient` æ¨¡å—åœ¨ä¸åŒå­ç«™ç‹¬ç«‹è¿è¡Œï¼Œä¸å½±å“å…¶ä»–ç«™ç‚¹çš„æ”¯ä»˜é€»è¾‘ã€‚  
- **æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–**ï¼šç¡®ä¿ `_site_id` å­—æ®µæ·»åŠ ç´¢å¼•ï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½ã€‚  
  ```sql  
  ALTER TABLE wp_postmeta ADD INDEX meta_key_site_id (meta_key, meta_value(20));  
  ```  

---

### **æ€»ç»“**  
æœ¬æ¬¡æ›´æ–°å¯¹ `APIClient` æ¨¡å—è¿›è¡Œäº†ä¼˜åŒ–ï¼Œç¡®ä¿æ‰€æœ‰æ”¯ä»˜é›†æˆåŠŸèƒ½å¿…é¡»ä½¿ç”¨å®˜æ–¹ SDKï¼Œå¹¶æå‡äº†æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½å’Œæ¨¡å—è§£è€¦æ€§ã€‚

